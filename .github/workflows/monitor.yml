name: Oracle Proxy Monitor

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  schedule:
    - cron: '30 5 * * *' # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤í›„ 2ì‹œ 30ë¶„ ìë™ ì‹¤í–‰ (UTC 05:30)

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Libraries
      run: |
        pip install pandas openpyxl uiautomator2

    - name: Setup SSH Tunnel (Korea IP)
      env:
        ORACLE_KEY: ${{ secrets.ORACLE_KEY }}
        ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
        ORACLE_USER: ${{ secrets.ORACLE_USER }}
      run: |
        # SSH í‚¤ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
        mkdir -p ~/.ssh
        echo "$ORACLE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # ì˜¤ë¼í´ ì„œë²„ ì§€ë¬¸ ë“±ë¡
        ssh-keyscan -H $ORACLE_HOST >> ~/.ssh/known_hosts
        
        # í„°ë„ë§ ì‹œì‘ (8080í¬íŠ¸ -> ì˜¤ë¼í´)
        echo "ğŸš€ ì˜¤ë¼í´ ì„œë²„ë¡œ í„°ë„ ëš«ëŠ” ì¤‘..."
        ssh -D 8080 -f -C -q -N -i ~/.ssh/id_rsa $ORACLE_USER@$ORACLE_HOST
        echo "âœ… í„°ë„ ì—°ê²° ì™„ë£Œ"

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Run Android Emulator & Script
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: default
        arch: x86_64
        profile: Nexus 6
        # â˜… í•µì‹¬: ì—ë®¬ë ˆì´í„°ê°€ 8080 í¬íŠ¸(ì˜¤ë¼í´ í„°ë„)ë¥¼ í†µí•´ ì¸í„°ë„·ì„ ì“°ë„ë¡ ì„¤ì •
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -http-proxy 127.0.0.1:8080
        script: python main.py

    - name: Upload Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youtube-report
        path: result.xlsx
